<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">
<link rel="import" href="../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="elements/splash-screen/splash-screen.html">

<link rel="import" href="elements/ht-tools/ht-export-key.html">
<link rel="import" href="elements/ht-tools/ht-import-keychain.html">
<link rel="import" href="elements/ht-tools/ht-my-profile.html">
<link rel="import" href="elements/ht-app/ht-app-login-dialog.html">
<link rel="import" href="elements/ht-app/ht-app-register-keypair-dialog.html">
<link rel="import" href="elements/menu-bar/menu-bar.html">
<link rel="import" href="elements/menu-bar/menu-bar.html">

<link rel="import" href="elements/icc-x-api/icc-x-api.html">

<link rel="import" href="./app-theme.html">
<link rel="import" href="./shared-styles.html">


<dom-module id="ht-app">

	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}

			app-header {
				color: var(--app-text-color-light);
				background-color: var(--app-primary-color-dark);
				height:64px;
				@apply --shadow-elevation-4dp;
			}

			app-header paper-icon-button {
				--paper-icon-button-ink-color: white;
			}

			app-toolbar {
				padding-right: 0;
				height:64px;
				display:flex;
				flex-flow: row nowrap;
				justify-content: space-between;
				align-items: stretch;
				
			}

			:host iron-pages {
				height: calc(100% - 64px);
			}

			:host app-header-layout {
				height: 100%;
			}

			iron-icon {
				max-height: 20px;
				width: 20px;
				margin-right: 8px;
				color: rgba(255,255,255,0.5);
			}

			iron-icon.smaller {
				height: 16px!important;
				width: 16px!important;
			}

			.icure-logo {
				float: left;
				height: 64px;
				margin-right: 8px;
			}

			paper-menu-button {
				position: relative;
			
				transform: translateY(-50%);
				--paper-menu-button-content: {
					width:300px;
				};
				--paper-menu-button-dropdown: {
					padding:0;
				}
			}

			.extra-menu{
				padding: 0;
			}
			.extra-menu-item{
				--paper-item-focused: {
					background: white;
				}
			}
			.extra-menu-item:last-child{
				border-top:1px solid var(--app-background-color-dark);				
			}

			paper-tabs {
				--paper-tabs-selection-bar-color: var(--app-secondary-color);
				height: 64px;
			}

			paper-tab {
				--paper-tab-ink: var(--app-secondary-color);
			}

			paper-tab.iron-selected {
				font-weight: bold;
			}

			paper-tab.iron-selected > iron-icon {
				color: var(--app-secondary-color);
			}

			.mobile-menu-btn {
				align-self: center;
				display: none;
			}
			
			.mobile-menu {
				position: fixed;
				top: 64px;
				left: 0;
				bottom: 0;
				background: var(--app-light-color);
				height: calc(100vh - 64px);
				overflow: hidden;
				width: 0;
				transition: width .24s cubic-bezier(0.4, 0.0, 0.2, 1);
				visibility: hidden;
				@apply --shadow-elevation-6dp;
				padding: 0 1em;
			}

			.mobile-menu.open {
				visibility: visible;
				width: 180px;
			}

			.mobile-menu paper-button {
				font-size: 14px;
				color: var(--app-text-color);
				width: 100%;
				margin: 8px 0;
				justify-content: flex-start;
				--paper-button-ink-color: var(--app-secondary-color);
			}

			.mobile-menu paper-button iron-icon {
				color: var(--app-text-color-disabled);
			}

			.mobile-menu paper-button.iron-selected {
				font-weight: 600;
			}

			.mobile-menu paper-button.iron-selected iron-icon {
				color: var(--app-secondary-color);
			}

			.mobile-menu-overlay {
				position: absolute;
				top: 64px;
				left: 0;
				width: 100vw;
				height: calc(100vh - 64px);
				display: none;
				background: var(--app-text-color-disabled);
			}

			.mobile-menu-overlay.open {
				display: block;

			}

			.mobile-menu-container {
				display: none;
			}

			@media (max-width: 768px) {
				paper-button {
					margin-right: 10px;
				}
				paper-tabs {
					display: none;
				}
				.mobile-menu-btn {
					display: block;
				}
				.mobile-menu-container {
					display: block;
				}
			}

			.logo{
				width:150px;
				height: 65px;
			}
		</style>

		<icc-x-api id="api" host="/rest/v1" fhc-host="https://fhcacc.icure.cloud" headers="[[headers]]" credentials="[[credentials]]"></icc-x-api>

		<ht-app-login-dialog id="loginDialog" credentials="[[credentials]]" on-login="login"></ht-app-login-dialog>
		<ht-app-register-keypair-dialog id="registerKeyPairDialog" api="[[api]]" user="[[user]]" message="[[registerKeyPairDialogMessage]]" on-file-selected="importPrivateKey" on-key-scanned="importScannedPrivateKey"></ht-app-register-keypair-dialog>
		<ht-export-key id="export-key" api="[[api]]" user="[[user]]"></ht-export-key>
		<ht-import-keychain id="ht-import-keychain" api="[[api]]" user="[[user]]"></ht-import-keychain>
		<ht-my-profile id="ht-my-profile" api="[[api]]" user="[[user]]"></ht-my-profile>


		<app-location route="{{route}}" use-hash-as-path="true"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
		<app-route route="{{subroute}}" pattern="/:page" data="{{subrouteData}}"></app-route>

		<app-drawer-layout fullbleed>
			<!-- Main content -->
			<app-header-layout fullbleed>
				<app-header slot="header" fixed condenses effects="waterfall">
					<app-toolbar id="mainToolbar" class="" sticky>	
						<!-- Mobile Menu -->
						<paper-icon-button class="mobile-menu-btn" icon="menu" on-tap="_triggerMenu"></paper-icon-button>
						<div class="mobile-menu-container">
							<div id="overlayMenu" class="mobile-menu-overlay" on-tap="_triggerMenu"></div>
								<paper-listbox  id="mobileMenu" class="mobile-menu" selected="[[routeData.page]]" attr-for-selected="name">
									<paper-button name="main" on-tap="doRoute">
										<iron-icon class="iron-icon" icon="home"></iron-icon>
										Summary
									</paper-button>
									<paper-button name="pat" on-tap="doRoute">
										<iron-icon icon="vaadin:user-heart"></iron-icon>
										Patients
									</paper-button>
									<paper-button name="hcp" on-tap="doRoute">
										<iron-icon icon="vaadin:hospital"></iron-icon>
										HC parties
									</paper-button>
									<paper-button name="msg" on-tap="doRoute">
										<iron-icon icon="communication:email"></iron-icon>
										Messages
									</paper-button>
									<paper-button name="logout" on-tap="doRoute">
										<iron-icon icon="power-settings-new"></iron-icon>
										Log out
									</paper-button>
								</paper-listbox>
							</div>
						</div>
						<!-- Regular Tabs Menu -->
						<paper-tabs selected="[[routeData.page]]" attr-for-selected="name" role="navigation">
							<paper-tab name="main" on-tap="doRoute">
								<iron-icon class="iron-icon" icon="home"></iron-icon>
								Summary
							</paper-tab>
							<paper-tab name="pat" on-tap="doRoute">
								<iron-icon class="smaller" icon="vaadin:user-heart"></iron-icon>
								Patients
							</paper-tab>
							<paper-tab name="hcp" on-tap="doRoute">
								<iron-icon class="smaller" icon="vaadin:hospital"></iron-icon>
								HC parties
							</paper-tab>
							<paper-tab name="msg" on-tap="doRoute">
								<iron-icon class="smaller" icon="communication:email"></iron-icon>
								Messages
							</paper-tab>
							<paper-tab name="logout" on-tap="doRoute">
								<iron-icon icon="power-settings-new"></iron-icon>
								Log out
							</paper-tab>
						</paper-tabs>
						<div>
							<!-- Generator: Adobe Illustrator 22.1.0, SVG Export Plug-In  -->
								<svg version="1.1"
								xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:a="http://ns.adobe.com/AdobeSVGViewerExtensions/3.0/"
								x="0px" y="0px" width="1378px" height="558px" viewBox="0 0 1378 558" style="enable-background:new 0 0 1378 558;"
								xml:space="preserve" class="logo">
								<style type="text/css">
								.st0{fill:url(#SVGID_1_);}
								.st1{fill:#F7F5F2;}
								.st2{fill:url(#SVGID_2_);}
								.st3{fill:url(#SVGID_3_);}
								.st4{fill:url(#SVGID_4_);}
								.st5{fill:url(#SVGID_5_);}
								.st6{fill:url(#SVGID_6_);}
								.st7{fill:url(#SVGID_7_);}
								.st8{fill:url(#SVGID_8_);}
								.st9{fill:url(#SVGID_9_);}
								.st10{opacity:0.1;fill:#FFFFFF;}
								.st11{opacity:0.15;fill:#FFFFFF;}
								.st12{fill:#FFFFFF;}
								.st13{fill:url(#SVGID_10_);}
								.st14{fill:url(#SVGID_11_);}
								.st15{fill:url(#SVGID_12_);}
								.st16{fill:url(#SVGID_13_);}
								.st17{fill:url(#SVGID_14_);}
								.st18{fill:url(#SVGID_15_);}
								.st19{fill:url(#SVGID_16_);}
								.st20{fill:url(#SVGID_17_);}
								.st21{fill:url(#SVGID_18_);}
								</style>
								<defs>
								</defs>
								<g>
								<g>
								<path class="st1" d="M508.3,226.7v-13.1h94.9v13.1h-40.1V345h-14.4V226.7H508.3z"/>
								<path class="st1" d="M742.1,280.2c0,23.4-3.7,40.4-11.2,50.9c-7.5,10.5-21,15.8-40.7,15.8c-19.7,0-33.3-5.4-40.7-16.1
									c-7.5-10.8-11.2-27.7-11.2-50.8c0-23.1,3.8-40.2,11.4-51.4c7.6-11.2,21.1-16.8,40.4-16.8c19.4,0,32.9,5.6,40.5,16.7
									C738.3,239.6,742.1,256.8,742.1,280.2z M653.3,279.9c0,19.2,2.5,33.1,7.6,41.5c5.1,8.4,14.8,12.6,29.3,12.6
									c14.5,0,24.2-4.1,29.2-12.3c5-8.2,7.5-22,7.5-41.4c0-19.4-2.6-33.5-7.8-42.3c-5.2-8.9-14.9-13.3-29.1-13.3
									c-14.2,0-23.9,4.4-29,13.2C655.9,246.6,653.3,260.6,653.3,279.9z"/>
								<path class="st1" d="M846.6,300.7h-33.4V345h-14.6V213.6h48c14.3,0,24.9,3.5,31.7,10.4c6.8,7,10.3,17.6,10.3,31.9
									C888.5,285.8,874.6,300.7,846.6,300.7z M813.2,287.8h33.2c18.1,0,27.1-10.6,27.1-31.9c0-10.1-2.2-17.6-6.5-22.3
									c-4.3-4.7-11.2-7.1-20.7-7.1h-33.2V287.8z"/>
								<path class="st1" d="M925.3,345l36.1-131.4h31.9l36.1,131.4h-14.4l-9.5-33.8h-56.2l-9.5,33.8H925.3z M972.4,226.1l-19.9,71.9h49.7
									l-19.9-71.9H972.4z"/>
								<path class="st1" d="M1074.7,226.5v-12.9h85.4v17.1l-68.7,97.6v3.8h68.7v13.1h-85.4v-16.9l68.5-97.6v-4.2H1074.7z"/>
								<path class="st1" d="M1209.1,345V213.6h79.9v12.9h-65.3v45.4h53.9v12.7h-53.9v47.5h65.3V345H1209.1z"/>
								</g>
								<g>
								<linearGradient id="SVGID_2_" gradientUnits="userSpaceOnUse" x1="94.044" y1="279.2923" x2="489.2183" y2="279.2923">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st2" points="489.2,355.7 346.3,108.2 236.9,108.2 94,355.7 148.7,450.4 434.5,450.4 		"/>
								<linearGradient id="SVGID_3_" gradientUnits="userSpaceOnUse" x1="188.0851" y1="269.1917" x2="449.034" y2="269.1917">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st3" points="291.6,160.9 166.6,377.4 416.6,377.4 		"/>
								<linearGradient id="SVGID_4_" gradientUnits="userSpaceOnUse" x1="291.6312" y1="169.0599" x2="291.6312" y2="90.2453">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st4" points="236.9,108.2 291.6,160.9 346.3,108.2 		"/>
								<linearGradient id="SVGID_5_" gradientUnits="userSpaceOnUse" x1="202.9194" y1="365.1869" x2="120.4543" y2="403.4743">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st5" points="148.7,450.4 166.6,377.4 94,355.7 		"/>
								
									<linearGradient id="SVGID_6_" gradientUnits="userSpaceOnUse" x1="-512.3033" y1="364.1474" x2="-594.7684" y2="402.4348" gradientTransform="matrix(-1 0 0 1 -134.1993 0)">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st6" points="434.5,450.4 416.6,377.4 489.2,355.7 		"/>
								<linearGradient id="SVGID_7_" gradientUnits="userSpaceOnUse" x1="249.7036" y1="288.9718" x2="158.403" y2="227.123">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st7" points="236.9,108.2 94,355.7 166.6,377.4 291.6,160.9 		"/>
								<linearGradient id="SVGID_8_" gradientUnits="userSpaceOnUse" x1="348.9492" y1="266.0075" x2="426.2601" y2="227.7202">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st8" points="489.2,355.7 346.3,108.2 291.6,160.9 416.6,377.4 		"/>
								<linearGradient id="SVGID_9_" gradientUnits="userSpaceOnUse" x1="291.6312" y1="347.7353" x2="291.6312" y2="443.931">
									<stop  offset="0" style="stop-color:#FFEB3B"/>
									<stop  offset="0.41" style="stop-color:#FFC107"/>
									<stop  offset="0.6602" style="stop-color:#FFA000"/>
									<stop  offset="1" style="stop-color:#FF5722"/>
								</linearGradient>
								<polygon class="st9" points="166.6,377.4 148.7,450.4 434.5,450.4 416.6,377.4 		"/>
								<polygon class="st10" points="346.3,108.2 236.9,108.2 129.8,293.8 166.6,377.4 387,326.1 413.2,224 		"/>
								<polygon class="st11" points="346.3,108.2 236.9,108.2 156.2,248.1 192.8,332.1 350.8,263.3 378.9,164.6 		"/>
								<g>
									<path class="st12" d="M291.6,161c-1-0.8-1.9-1.6-2.9-2.4l-2.8-2.5c-1.9-1.7-3.7-3.4-5.6-5.1c-3.7-3.4-7.2-7-10.7-10.5L259,129.9
										l-10.6-10.6l0.1-0.1l11,10.2l11,10.3c3.7,3.4,7.4,6.8,10.9,10.3c1.8,1.8,3.5,3.6,5.2,5.4l2.6,2.7c0.8,0.9,1.7,1.8,2.5,2.8
										L291.6,161z"/>
									<path class="st12" d="M291.6,160.9c0.8-0.9,1.7-1.9,2.5-2.8l2.6-2.7c1.7-1.8,3.5-3.6,5.2-5.4c3.5-3.5,7.3-6.9,10.9-10.3l11-10.3
										l11-10.2l0.1,0.1l-10.6,10.6l-10.7,10.6c-3.5,3.5-7,7.1-10.7,10.5c-1.8,1.7-3.7,3.4-5.6,5.1l-2.8,2.5c-1,0.8-1.9,1.6-2.9,2.4
										L291.6,160.9z"/>
									<path class="st12" d="M291.8,161c-2.9,5.9-6,11.7-9.1,17.5c-3.1,5.8-6.3,11.6-9.5,17.3c-6.4,11.5-13.3,22.7-20,34l-20.1,34
										l-20.3,33.9l-0.3-0.1l19.2-34.5l19.4-34.4c6.5-11.5,12.7-23.1,19.5-34.3c3.4-5.6,6.8-11.3,10.2-16.9c3.5-5.6,7-11.2,10.6-16.7
										L291.8,161z"/>
									<path class="st12" d="M291.8,160.9c3.6,5.5,7.2,11.1,10.6,16.7c3.5,5.6,6.9,11.2,10.2,16.9c6.8,11.3,13,22.9,19.5,34.3l19.4,34.4
										l19.2,34.5l-0.3,0.1l-20.3-33.9l-20.1-34c-6.7-11.3-13.6-22.5-20-34c-3.2-5.8-6.4-11.5-9.5-17.3c-3.1-5.8-6.2-11.6-9.1-17.5
										L291.8,160.9z"/>
								</g>
								</g>
								</g>
							</svg>

							<paper-menu-button horizontal-align="right" close-on-activate no-overlap no-animations focused="false">
								<paper-icon-button icon="icons:more-vert" slot="dropdown-trigger" alt="menu"></paper-icon-button>
								<paper-listbox class="extra-menu" slot="dropdown-content"  stop-keyboard-event-propagation>
									<div class="dropdown-content"></div><!-- workaround to fix that the fist element of the list was always focus -->
									<paper-item class="extra-menu-item" on-tap="_openExportKey">Transfer private key / Connect tablet</paper-item>
									<paper-item class="extra-menu-item" on-tap="_importKeychain">Import my eHealth keychain</paper-item>
									<paper-item class="extra-menu-item" on-tap="_myProfile">My profile</paper-item>
								</paper-listbox>
							</paper-menu-button>
						</div>
					</app-toolbar>

				</app-header>
				<iron-pages
						selected="[[view]]"
						attr-for-selected="name"
						fallback-selection="view404"
						role="main">
					<ht-main name="main" api="[[api]]" user="[[user]]"><splash-screen></splash-screen></ht-main>
					<ht-pat name="pat" api="[[api]]" user="[[user]]" route="{{subroute}}"><splash-screen></splash-screen></ht-pat>
					<ht-hcp name="hcp" api="[[api]]" user="[[user]]"><splash-screen></splash-screen></ht-hcp>
					<ht-msg name="msg" host="/rest/v1" headers="[[headers]]"><splash-screen></splash-screen></ht-msg>
					<ht-view404 name="view404"></ht-view404>
				</iron-pages>
			</app-header-layout>
		</app-drawer-layout>
	</template>

	<script>
		Polymer({
			is: 'ht-app',

			properties: {
				api: {
					type: Object,
					value: null
				},
				user: {
					type: Object,
					value: null
				},
				view: {
					type: String,
					reflectToAttribute: true,
					observer: '_viewChanged'
				},
				headers: {
					type: Object,
					value: {"Content-Type": "application/json"}
				},
				credentials: {
					type: Object,
					value: {logout: false}
				},
				lazyPages: {
					type: Object,
					value: {
						main: function() {
							import(/* webpackChunkName: "ht-main" */ './ht-main.html')
						},
						pat: function() {
							import(/* webpackChunkName: "ht-pat" */ './ht-pat.html')
						},
						hcp: function() {
							import(/* webpackChunkName: "ht-hcp" */ './ht-hcp.html')
						},
						msg: function() {
							import(/* webpackChunkName: "ht-msg" */ './ht-msg.html')
						},
						view404: function() {
							import(/* webpackChunkName: "ht-view404" */ './ht-view404.html')
						}
					}
				}
			},

			observers: [
				'_routePageChanged(routeData.page)'
			],

			ready: function () {
				let newHref = window.location.href.includes('#/') ? window.location.href : window.location.href.replace(/\/?#?$/,'/#')
				let fullHref = newHref.endsWith('/') ? newHref : newHref +'/'
				if (fullHref !== window.location.href) { window.location.href = fullHref }
				window.app = this
				this.set('api', this.$.api)
			},

			_routePageChanged: function (page) {
				if (page === 'logout') {
					sessionStorage.removeItem('auth')
					this.authenticated = false
					this.set('view', 'auth');
				} else {
					console.log("page is -> "+page)
					if (!this.authenticated && (!page || !page.startsWith('auth'))) {
						if (sessionStorage.getItem('auth')) {
							this.loginAndRedirect(page)
						} else {
							this.set('routeData.page', 'auth/'+ (!page ? 'main' : page.startsWith('logout') ? 'main' : page));
						}
					} else {
						this.set('view', page ? page.replace(/\/$/,'') : 'main')
					}
				}
			},

			_triggerMenu: function() {
				let menu = this.$.mobileMenu
				let overlay = this.$.overlayMenu

				overlay.classList.toggle('open')
				menu.classList.toggle('open')


			},

			_viewChanged: function (view) {
				if (view.startsWith('auth')) {
					this.$.loginDialog.opened = true
					return
				}
				if(this.lazyPages[view]){
					this.lazyPages[view]();
				} else {
					this._showPage404();
				}
			},

			_showPage404: function () {
				this.view = 'view404';
			},

			doRoute: function (e) {
				this.set('routeData.page', (e.target.getAttribute('name') || e.target.parentElement.getAttribute('name'))+"/")
				this._triggerMenu()
			},

			_openExportKey: function() {
				this.$['export-key'].open()
			},

			_importKeychain: function() {
				this.$['ht-import-keychain'].open()
			},

			_myProfile: function() {
				this.$['ht-my-profile'].open()
			},

			loginAndRedirect: function(page) {
				const sAuth = JSON.parse(sessionStorage.getItem('auth'))
				if (!this.credentials || (!this.credentials.password && sAuth && sAuth.password) || (!this.credentials.appToken && sAuth && sAuth.appToken)) { this.set('credentials',sAuth) }
				if ((this.credentials.userId && this.credentials.appToken)) { this.set('headers.Authorization', 'Basic ' + btoa(this.credentials.userId + ':' + this.credentials.appToken)) }
				else if ((this.credentials.username && this.credentials.password)) { this.set('headers.Authorization', 'Basic ' + btoa(this.credentials.username + ':' + this.credentials.password + (this.credentials.twofa?'|'+this.credentials.twofa:''))) }

				//Be careful not to use this.api here as it might not have been defined yet
				this.$.api.user().getCurrentUser().then(u => {
					this.set('user', u)
					this.$.loginDialog.opened = false

					this.set('credentials.twofa',null)
					this.set('credentials.userId',u.id)
					this.set('credentials.appToken',u.applicationTokens && u.applicationTokens.ICC)

					if ((this.credentials.userId && this.credentials.appToken)) {
						this.set('credentials.password',null)
						this.set('headers.Authorization', 'Basic ' + btoa(this.credentials.userId + ':' + this.credentials.appToken))
					}
					sessionStorage.setItem('auth', JSON.stringify(this.credentials))

					if (!this.authenticated) {
						this.authenticated = true

						if (this.$.api.crypto().RSA.loadKeyPairNotImported(u.healthcarePartyId)) {
							if (this.credentials.ehpassword) {
								this.$.api.fhc().Stscontroller().uploadKeystoreUsingPOST(this.$.api.crypto().loadKeychainFromBrowserLocalStorage(this.user.healthcarePartyId)).then(res => {
									this.$.api.keystoreId = res.uuid
									this.$.api.hcparty().getHealthcareParty(u.healthcarePartyId).then(hcp =>
										this.$.api.fhc().Stscontroller().requestTokenUsingGET(this.credentials.ehpassword, hcp.ssin, this.$.api.keystoreId).then(res => {
											this.$.api.tokenId = res.tokenId
											this.$.api.token = res.token
										})
									)
								})
							}

							const destPage = page || (this.routeData && this.routeData.page === 'auth' && this.subrouteData && this.subrouteData.page ? this.subrouteData.page : 'main')
							if (!this.routeData || destPage !== this.routeData.page) {
								this.set('routeData.page', destPage);
							} else {
								this._routePageChanged(destPage)
							}
						} else {
							this.registerKeyPairDialogMessage = ""
							this.$.registerKeyPairDialog.opened = true
						}
					}
				}).catch(function (e) {
					this.authenticated = false
					sessionStorage.removeItem('auth')
					this.set("credentials.error", "Wrong user or password")
				}.bind(this))
			},

			login: function (event, loginObject) /* this is called from mouseDown with 2 arguments */ {
				this.set('credentials',loginObject && loginObject.credentials)
				this.loginAndRedirect(loginObject && loginObject.page)
			},

			importPrivateKey: function(e, selectedRsaFile) {
				selectedRsaFile && selectedRsaFile.name && this.api.crypto().loadKeyPairsInBrowserLocalStorage(this.user.healthcarePartyId, selectedRsaFile).then(function() {
					if (this.$.api.crypto().RSA.loadKeyPairNotImported(this.user.healthcarePartyId)) {
						this.$.registerKeyPairDialog.opened = false
						this.set("registerKeyPairDialogMessage","")
						this.set('routeData.page', 'main/');
					} else {
						this.set("registerKeyPairDialogMessage","Invalid key file")
						this.$.registerKeyPairDialog.reset()
					}
				}.bind(this)).catch(e => console.log(e))
			},

			importScannedPrivateKey: function(e, jwkKey) {
				this.api.crypto().loadKeyPairsAsJwkInBrowserLocalStorage(this.user.healthcarePartyId, jwkKey).then(function() {
					if (this.$.api.crypto().RSA.loadKeyPairNotImported(this.user.healthcarePartyId)) {
						this.$.registerKeyPairDialog.opened = false
						this.set("registerKeyPairDialogMessage","")
						this.set('routeData.page', 'main/');
					} else {
						this.set("registerKeyPairDialogMessage","Invalid key file")
						this.$.registerKeyPairDialog.reset()
					}
				}.bind(this)).catch(e => console.log(e))
			},

			togglePanel: function (e) {
			}
		})
	</script>
</dom-module>
